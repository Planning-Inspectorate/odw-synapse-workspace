{
	"name": "pln_orchestrator",
	"properties": {
		"activities": [
			{
				"name": "If_UsePreviousSummary",
				"type": "IfCondition",
				"dependsOn": [],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@and(\n  equals(pipeline().parameters.runInit, false),\n  not(equals(pipeline().parameters.previousRunSummaryPath, ''))\n)\n",
						"type": "Expression"
					},
					"ifFalseActivities": [
						{
							"name": "A_Init",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_vault_and_env_init",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"sbEntitiesFilter": {
										"value": "@pipeline().parameters.sbEntitiesFilter",
										"type": "Expression"
									},
									"hzEntitiesFilter": {
										"value": "@pipeline().parameters.hzEntitiesFilter",
										"type": "Expression"
									},
									"includeServiceBus": {
										"value": "@pipeline().parameters.runIngestSB",
										"type": "Expression"
									},
									"includeHorizon": {
										"value": "@pipeline().parameters.runIngestHZ",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_RunContext_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "runContextJson",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.runContextJson",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_SbEntities_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_RunContext_From_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbEntities",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.sbEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_HzEntities_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_SbEntities_From_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzEntities",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.hzEntities\n",
									"type": "Expression"
								}
							}
						}
					],
					"ifTrueActivities": [
						{
							"name": "Set_Context_From_Summary",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Lookup_Previous_Run_Summary",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "runContextJson",
								"value": {
									"value": "@string(activity('Lookup_Previous_Run_Summary').output.runContextJson)\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_SB_Entities",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_Context_From_Summary",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbEntities",
								"value": {
									"value": "@activity('Lookup_Previous_Run_Summary').output.sbEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_HZ_Entities",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_SB_Entities",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzEntities",
								"value": {
									"value": "@activity('Lookup_Previous_Run_Summary').output.hzEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Lookup_Previous_Run_Summary",
							"type": "Lookup",
							"dependsOn": [],
							"policy": {
								"timeout": "0.12:00:00",
								"retry": 0,
								"retryIntervalInSeconds": 30,
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"source": {
									"type": "JsonSource",
									"storeSettings": {
										"type": "AzureBlobFSReadSettings",
										"recursive": true,
										"enablePartitionDiscovery": false
									},
									"formatSettings": {
										"type": "JsonReadSettings"
									}
								},
								"dataset": {
									"referenceName": "ds_orchestrator_manifest_json",
									"type": "DatasetReference",
									"parameters": {
										"folderPath": {
											"value": "@substring(\n  pipeline().parameters.previousRunSummaryPath,\n  0,\n  lastIndexOf(pipeline().parameters.previousRunSummaryPath, '/')\n)\n",
											"type": "Expression"
										},
										"fileName": {
											"value": "@substring(\n  pipeline().parameters.previousRunSummaryPath,\n  add(lastIndexOf(pipeline().parameters.previousRunSummaryPath, '/'), 1),\n  sub(\n    length(pipeline().parameters.previousRunSummaryPath),\n    add(lastIndexOf(pipeline().parameters.previousRunSummaryPath, '/'), 1)\n  )\n)\n",
											"type": "Expression"
										}
									}
								}
							}
						}
					]
				}
			},
			{
				"name": "If_RunSB_Ingest",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_UsePreviousSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runIngestSB\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_SB_Ingest",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_service_bus_ingest",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"runContextJson": {
										"value": "@variables('runContextJson')",
										"type": "Expression"
									},
									"sbEntities": {
										"value": "@variables('sbEntities')",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_sbResult_From_SB",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_SB_Ingest",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbResultJson",
								"value": {
									"value": "@activity('A_SB_Ingest').output.pipelineReturnValue.result\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "If_RunHZ_Ingest",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_UsePreviousSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runIngestHZ\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_HZ_Ingest",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_horizon_ingest",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"runContextJson": {
										"value": "@variables('runContextJson')",
										"type": "Expression"
									},
									"hzEntities": {
										"value": "@variables('hzEntities')",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_hzResult_From_HZ",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_HZ_Ingest",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzResultJson",
								"value": {
									"value": "@activity('A_HZ_Ingest').output.pipelineReturnValue.result\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "Build_RunSummary",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "If_RunSB_Ingest",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "If_RunHZ_Ingest",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "runSummaryJson",
					"value": {
						"value": "@concat(\n  '{',\n    '\"orchestrator\":\"pln_orchestrator\",',\n    '\"runId\":\"', pipeline().RunId, '\",',\n    '\"runContextJson\":', variables('runContextJson'), ',',\n    '\"sbEntities\":', string(variables('sbEntities')), ',',\n    '\"hzEntities\":', string(variables('hzEntities')), ',',\n    '\"sbResult\":', variables('sbResultJson'), ',',\n    '\"hzResult\":', variables('hzResultJson'),\n  '}'\n)\n",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Return_RunSummary",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Write_Orchestrator_Manifest",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "pipelineReturnValue",
					"value": [
						{
							"key": "runSummaryJson",
							"value": {
								"type": "Expression",
								"content": "@variables('runSummaryJson')\n"
							}
						},
						{
							"key": "manifestPath",
							"value": {
								"type": "Expression",
								"content": "@variables('manifestPath')"
							}
						}
					],
					"setSystemVariable": true
				}
			},
			{
				"name": "Build_Manifest_Path",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Build_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "manifestPath",
					"value": {
						"value": "@concat(\n  'Orchestrator_Manifests/pln_orchestrator/runs/ingest_date=',\n  json(variables('runContextJson')).ingestDate,\n  '/run_id=',\n  json(variables('runContextJson')).runId,\n  '/manifest.json'\n)\n",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Write_Orchestrator_Manifest",
				"type": "SynapseNotebook",
				"dependsOn": [
					{
						"activity": "Build_Manifest_Path",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"notebook": {
						"referenceName": "nb_write_orchestrator_manifest",
						"type": "NotebookReference"
					},
					"parameters": {
						"runSummaryJson": {
							"value": "@variables('runSummaryJson')",
							"type": "string"
						},
						"runContextJson": {
							"value": "@variables('runContextJson')",
							"type": "string"
						},
						"manifestPath": {
							"value": "@variables('manifestPath')",
							"type": "string"
						},
						"status": {
							"value": "'Succeeded'",
							"type": "string"
						}
					},
					"snapshot": true,
					"sparkPool": {
						"referenceName": "pinssynspodw34",
						"type": "BigDataPoolReference"
					},
					"executorSize": "Small",
					"driverSize": "Small",
					"authentication": {
						"type": "MSI"
					}
				}
			}
		],
		"parameters": {
			"runInit": {
				"type": "bool",
				"defaultValue": true
			},
			"runIngestSB": {
				"type": "bool",
				"defaultValue": true
			},
			"runIngestHZ": {
				"type": "bool",
				"defaultValue": true
			},
			"sbEntitiesFilter": {
				"type": "array",
				"defaultValue": []
			},
			"hzEntitiesFilter": {
				"type": "array",
				"defaultValue": []
			},
			"previousRunSummaryPath": {
				"type": "string",
				"defaultValue": "''"
			}
		},
		"variables": {
			"runContextJson": {
				"type": "String"
			},
			"sbEntities": {
				"type": "Array"
			},
			"hzEntities": {
				"type": "Array"
			},
			"sbResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"hzResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"runSummaryJson": {
				"type": "String"
			},
			"manifestPath": {
				"type": "String"
			}
		},
		"folder": {
			"name": "utils/Master"
		},
		"annotations": []
	}
}