{
	"name": "pln_orchestrator",
	"properties": {
		"activities": [
			{
				"name": "If_UsePreviousSummary",
				"type": "IfCondition",
				"dependsOn": [],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@and(\n  equals(pipeline().parameters.runInit, false),\n  not(equals(pipeline().parameters.previousRunSummaryPath, ''))\n)\n",
						"type": "Expression"
					},
					"ifFalseActivities": [
						{
							"name": "A_Init",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_vault_and_env_init",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"sbEntitiesFilter": {
										"value": "@pipeline().parameters.sbEntitiesFilter",
										"type": "Expression"
									},
									"hzEntitiesFilter": {
										"value": "@pipeline().parameters.hzEntitiesFilter",
										"type": "Expression"
									},
									"includeServiceBus": {
										"value": "@pipeline().parameters.runIngestSB",
										"type": "Expression"
									},
									"includeHorizon": {
										"value": "@pipeline().parameters.runIngestHZ",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_RunContext_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "runContextJson",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.runContextJson",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_SbEntities_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_RunContext_From_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbEntities",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.sbEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_HzEntities_From_Init",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_SbEntities_From_Init",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzEntities",
								"value": {
									"value": "@activity('A_Init').output.pipelineReturnValue.hzEntities\n",
									"type": "Expression"
								}
							}
						}
					],
					"ifTrueActivities": [
						{
							"name": "Set_Context_From_Summary",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Lookup_Previous_Run_Summary",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "runContextJson",
								"value": {
									"value": "@string(activity('Lookup_Previous_Run_Summary').output.firstRow.runContextJson)\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_SB_Entities",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_Context_From_Summary",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbEntities",
								"value": {
									"value": "@activity('Lookup_Previous_Run_Summary').output.firstRow.sbEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Set_HZ_Entities",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "Set_SB_Entities",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": true,
								"secureInput": true
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzEntities",
								"value": {
									"value": "@activity('Lookup_Previous_Run_Summary').output.firstRow.hzEntities\n",
									"type": "Expression"
								}
							}
						},
						{
							"name": "Lookup_Previous_Run_Summary",
							"type": "Lookup",
							"dependsOn": [],
							"policy": {
								"timeout": "0.12:00:00",
								"retry": 0,
								"retryIntervalInSeconds": 30,
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"source": {
									"type": "JsonSource",
									"storeSettings": {
										"type": "AzureBlobFSReadSettings",
										"recursive": true,
										"enablePartitionDiscovery": false
									},
									"formatSettings": {
										"type": "JsonReadSettings"
									}
								},
								"dataset": {
									"referenceName": "ds_orchestrator_manifest_json",
									"type": "DatasetReference",
									"parameters": {
										"folderPath": {
											"value": "@substring(\n  trim(pipeline().parameters.previousRunSummaryPath),\n  0,\n  lastIndexOf(trim(pipeline().parameters.previousRunSummaryPath), '/')\n)\n",
											"type": "Expression"
										},
										"fileName": {
											"value": "@substring(\n  trim(pipeline().parameters.previousRunSummaryPath),\n  add(lastIndexOf(trim(pipeline().parameters.previousRunSummaryPath), '/'), 1),\n  sub(\n    length(trim(pipeline().parameters.previousRunSummaryPath)),\n    add(lastIndexOf(trim(pipeline().parameters.previousRunSummaryPath), '/'), 1)\n  )\n)\n",
											"type": "Expression"
										}
									}
								}
							}
						}
					]
				}
			},
			{
				"name": "If_RunSB_Ingest",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_UsePreviousSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runIngestSB\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_SB_Ingest",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_service_bus_ingest",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"runContextJson": {
										"value": "@variables('runContextJson')",
										"type": "Expression"
									},
									"sbEntities": {
										"value": "@variables('sbEntities')",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_sbResult_From_SB",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_SB_Ingest",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "sbResultJson",
								"value": {
									"value": "@activity('A_SB_Ingest').output.pipelineReturnValue.result\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "If_RunHZ_Ingest",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_UsePreviousSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runIngestHZ\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_HZ_Ingest",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_horizon_ingest",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"runContextJson": {
										"value": "@variables('runContextJson')",
										"type": "Expression"
									},
									"hzEntities": {
										"value": "@variables('hzEntities')",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_hzResult_From_HZ",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_HZ_Ingest",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "hzResultJson",
								"value": {
									"value": "@activity('A_HZ_Ingest').output.pipelineReturnValue.result\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "Build_RunSummary",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "If_RunMiPINS_Copy",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": true,
					"secureInput": true
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "runSummaryJson",
					"value": {
						"value": "@concat(\n  '{',\n    '\\\"orchestrator\\\":\\\"pln_orchestrator\\\",',\n    '\\\"runId\\\":\\\"', pipeline().RunId, '\\\",',\n    '\\\"runContextJson\\\":', variables('runContextJson'), ',',\n    '\\\"sbEntities\\\":', string(variables('sbEntities')), ',',\n    '\\\"hzEntities\\\":', string(variables('hzEntities')), ',',\n    '\\\"mipinsEntities\\\":', string(pipeline().parameters.mipinsEntitiesFilter), ',',\n    '\\\"sbResult\\\":', variables('sbResultJson'), ',',\n    '\\\"hzResult\\\":', variables('hzResultJson'), ',',\n    '\\\"transformResult\\\":', variables('transformResultJson'), ',',\n    '\\\"mipinsResult\\\":', variables('mipinsResultJson'),\n  '}'\n)\n",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Return_RunSummary",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Write_Orchestrator_Manifest",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": true,
					"secureInput": true
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "pipelineReturnValue",
					"value": [
						{
							"key": "runSummaryJson",
							"value": {
								"type": "Expression",
								"content": "@variables('runSummaryJson')\n"
							}
						},
						{
							"key": "manifestPath",
							"value": {
								"type": "Expression",
								"content": "@variables('manifestPath')"
							}
						}
					],
					"setSystemVariable": true
				}
			},
			{
				"name": "Build_Manifest_Path",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Build_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": true,
					"secureInput": true
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "manifestPath",
					"value": {
						"value": "@concat(\n  'Orchestrator_Manifests/pln_orchestrator/runs/ingest_date=',\n  formatDateTime(utcNow(), 'yyyy-MM-dd'),\n  '/run_id=',\n  json(variables('runContextJson')).runId,\n  '/manifest.json'\n)\n",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Write_Orchestrator_Manifest",
				"type": "SynapseNotebook",
				"dependsOn": [
					{
						"activity": "Build_Manifest_Path",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": true,
					"secureInput": true
				},
				"userProperties": [],
				"typeProperties": {
					"notebook": {
						"referenceName": "nb_write_orchestrator_manifest",
						"type": "NotebookReference"
					},
					"parameters": {
						"runSummaryJson": {
							"value": {
								"value": "@variables('runSummaryJson')",
								"type": "Expression"
							},
							"type": "string"
						},
						"runContextJson": {
							"value": {
								"value": "@variables('runContextJson')",
								"type": "Expression"
							},
							"type": "string"
						},
						"manifestPath": {
							"value": {
								"value": "@variables('manifestPath')",
								"type": "Expression"
							},
							"type": "string"
						},
						"status": {
							"value": "'Succeeded'",
							"type": "string"
						}
					},
					"snapshot": true,
					"sparkPool": {
						"referenceName": "pinssynspodw34",
						"type": "BigDataPoolReference"
					},
					"executorSize": "Small",
					"conf": {
						"spark.dynamicAllocation.enabled": null,
						"spark.dynamicAllocation.minExecutors": null,
						"spark.dynamicAllocation.maxExecutors": null
					},
					"driverSize": "Small",
					"numExecutors": null,
					"authentication": {
						"type": "MSI"
					}
				}
			},
			{
				"name": "If_HasFailures",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "ForEach_SB_Results",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "ForEach_HZ_Results",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "ForEach_MiPINS_Results",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "ForEach_Transform_Results",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@or(\n  or(\n    greater(length(variables('sbFailedEntities')), 0),\n    greater(length(variables('hzFailedEntities')), 0)\n  ),\n  or(\n    greater(length(variables('transformFailedEntities')), 0),\n    greater(length(variables('mipinsFailedEntities')), 0)\n  )\n)\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "Fail_If_HasFailures",
							"type": "Fail",
							"dependsOn": [
								{
									"activity": "Build_Failure_Message",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"userProperties": [],
							"typeProperties": {
								"message": {
									"value": "@variables('failureMessage')",
									"type": "Expression"
								},
								"errorCode": "ORCH_INGEST_FAILURE"
							}
						},
						{
							"name": "Build_Failure_Message",
							"type": "SetVariable",
							"dependsOn": [],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "failureMessage",
								"value": {
									"value": "@concat(\n  'One or more stages failed. ',\n  if(\n    greater(length(variables('sbFailedEntities')), 0),\n    concat(\n      'SB failed entities: ', join(variables('sbFailedEntities'), ', '),\n      '. Errors: ', join(variables('sbFailedErrors'), ' | '),\n      '. '\n    ),\n    ''\n  ),\n  if(\n    greater(length(variables('hzFailedEntities')), 0),\n    concat(\n      'HZ failed entities: ', join(variables('hzFailedEntities'), ', '),\n      '. Errors: ', join(variables('hzFailedErrors'), ' | '),\n      '. '\n    ),\n    ''\n  ),\n  if(\n    greater(length(variables('transformFailedEntities')), 0),\n    concat(\n      'Transform failed entities: ', join(variables('transformFailedEntities'), ', '),\n      '. Errors: ', join(variables('transformFailedErrors'), ' | '),\n      '. '\n    ),\n    ''\n  ),\n  if(\n    greater(length(variables('mipinsFailedEntities')), 0),\n    concat(\n      'MiPINS failed entities: ', join(variables('mipinsFailedEntities'), ', '),\n      '. Errors: ', join(variables('mipinsFailedErrors'), ' | '),\n      '. '\n    ),\n    ''\n  ),\n  'Check orchestrator + entity manifests for details.'\n)\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "If_RunMiPINS_Copy",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_RunTransform_And_Load",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runCuratedToMiPINS\n",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_MiPINS_Copy",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_copy_curated_to_mipins_generic",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"p_EntityCodes": {
										"value": "@pipeline().parameters.mipinsEntitiesFilter\n",
										"type": "Expression"
									},
									"runContextJson": {
										"value": "@variables('runContextJson')\n",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_mipinsResult_From_MiPINS",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_MiPINS_Copy",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "mipinsResultJson",
								"value": {
									"value": "@activity('A_MiPINS_Copy').output.pipelineReturnValue.result\n",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "Init_SB_FailedEntities",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Return_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "sbFailedEntities",
					"value": {
						"value": "@json('[]')",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Init_HZ_FailedEntities",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Return_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "hzFailedEntities",
					"value": {
						"value": "@json('[]')",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Init_MiPINS_FailedEntities",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Return_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "mipinsFailedEntities",
					"value": {
						"value": "@json('[]')",
						"type": "Expression"
					}
				}
			},
			{
				"name": "ForEach_SB_Results",
				"type": "ForEach",
				"dependsOn": [
					{
						"activity": "Init_SB_FailedEntities",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"items": {
						"value": "@if(\n  equals(variables('sbResultJson'), 'null'),\n  json('[]'),\n  json(variables('sbResultJson')).results\n)\n",
						"type": "Expression"
					},
					"batchCount": 4,
					"activities": [
						{
							"name": "If_SB_Item_Failed",
							"type": "IfCondition",
							"dependsOn": [],
							"userProperties": [],
							"typeProperties": {
								"expression": {
									"value": "@equals(item().status,'Failed')\n",
									"type": "Expression"
								},
								"ifTrueActivities": [
									{
										"name": "Append SB failed entity",
										"type": "AppendVariable",
										"dependsOn": [],
										"userProperties": [],
										"typeProperties": {
											"variableName": "sbFailedEntities",
											"value": {
												"value": "@item().entity\n",
												"type": "Expression"
											}
										}
									},
									{
										"name": "Append SB failed error",
										"type": "AppendVariable",
										"dependsOn": [
											{
												"activity": "Append SB failed entity",
												"dependencyConditions": [
													"Succeeded"
												]
											}
										],
										"userProperties": [],
										"typeProperties": {
											"variableName": "sbFailedErrors",
											"value": {
												"value": "@concat(item().entity, ': ', coalesce(item().error, 'Unknown error'))\n",
												"type": "Expression"
											}
										}
									}
								]
							}
						}
					]
				}
			},
			{
				"name": "ForEach_HZ_Results",
				"type": "ForEach",
				"dependsOn": [
					{
						"activity": "Init_HZ_FailedEntities",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"items": {
						"value": "@if(\n  equals(variables('hzResultJson'), 'null'),\n  json('[]'),\n  json(variables('hzResultJson')).results\n)\n",
						"type": "Expression"
					},
					"batchCount": 4,
					"activities": [
						{
							"name": "If_HZ_Item_Failed",
							"type": "IfCondition",
							"dependsOn": [],
							"userProperties": [],
							"typeProperties": {
								"expression": {
									"value": "@equals(item().status,'Failed')\n",
									"type": "Expression"
								},
								"ifTrueActivities": [
									{
										"name": "Append HZ failed entity",
										"type": "AppendVariable",
										"dependsOn": [],
										"userProperties": [],
										"typeProperties": {
											"variableName": "hzFailedEntities",
											"value": {
												"value": "@item().entity",
												"type": "Expression"
											}
										}
									},
									{
										"name": "Append HZ failed error",
										"type": "AppendVariable",
										"dependsOn": [
											{
												"activity": "Append HZ failed entity",
												"dependencyConditions": [
													"Succeeded"
												]
											}
										],
										"userProperties": [],
										"typeProperties": {
											"variableName": "hzFailedErrors",
											"value": {
												"value": "@concat(item().entity, ': ', coalesce(item().error, 'Unknown error'))\n",
												"type": "Expression"
											}
										}
									}
								]
							}
						}
					]
				}
			},
			{
				"name": "ForEach_MiPINS_Results",
				"type": "ForEach",
				"dependsOn": [
					{
						"activity": "Init_MiPINS_FailedEntities",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"items": {
						"value": "@if(\n  equals(variables('mipinsResultJson'), 'null'),\n  json('[]'),\n  json(variables('mipinsResultJson')).results\n)\n",
						"type": "Expression"
					},
					"batchCount": 4,
					"activities": [
						{
							"name": "If_MiPINS_Item_Failed",
							"type": "IfCondition",
							"dependsOn": [],
							"userProperties": [],
							"typeProperties": {
								"expression": {
									"value": "@equals(item().status,'Failed')\n",
									"type": "Expression"
								},
								"ifTrueActivities": [
									{
										"name": "Append MiPINS failed entity",
										"type": "AppendVariable",
										"dependsOn": [],
										"userProperties": [],
										"typeProperties": {
											"variableName": "mipinsFailedEntities",
											"value": {
												"value": "@item().entity_code\n",
												"type": "Expression"
											}
										}
									},
									{
										"name": "Append MiPINS failed error",
										"type": "AppendVariable",
										"dependsOn": [
											{
												"activity": "Append MiPINS failed entity",
												"dependencyConditions": [
													"Succeeded"
												]
											}
										],
										"userProperties": [],
										"typeProperties": {
											"variableName": "mipinsFailedErrors",
											"value": {
												"value": "@concat(item().entity_code, ': ', coalesce(item().error, ''))\n",
												"type": "Expression"
											}
										}
									}
								]
							}
						}
					]
				}
			},
			{
				"name": "If_RunTransform_And_Load",
				"type": "IfCondition",
				"dependsOn": [
					{
						"activity": "If_RunSB_Ingest",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "If_RunHZ_Ingest",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"expression": {
						"value": "@pipeline().parameters.runTransformAndLoad",
						"type": "Expression"
					},
					"ifTrueActivities": [
						{
							"name": "A_Transform_And_Load",
							"type": "ExecutePipeline",
							"dependsOn": [],
							"policy": {
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"pipeline": {
									"referenceName": "pln_transform_and_load",
									"type": "PipelineReference"
								},
								"waitOnCompletion": true,
								"parameters": {
									"runContextJson": {
										"value": "@variables('runContextJson')",
										"type": "Expression"
									},
									"sbEntities": {
										"value": "@variables('sbEntities')",
										"type": "Expression"
									},
									"hzEntities": {
										"value": "@variables('hzEntities')",
										"type": "Expression"
									},
									"stages": {
										"value": "@pipeline().parameters.transformStages",
										"type": "Expression"
									},
									"retryCount": {
										"value": "@pipeline().parameters.transformRetryCount",
										"type": "Expression"
									}
								}
							}
						},
						{
							"name": "Set_transformResult_From_Transform",
							"type": "SetVariable",
							"dependsOn": [
								{
									"activity": "A_Transform_And_Load",
									"dependencyConditions": [
										"Succeeded"
									]
								}
							],
							"policy": {
								"secureOutput": false,
								"secureInput": false
							},
							"userProperties": [],
							"typeProperties": {
								"variableName": "transformResultJson",
								"value": {
									"value": "@activity('A_Transform_And_Load').output.pipelineReturnValue.result",
									"type": "Expression"
								}
							}
						}
					]
				}
			},
			{
				"name": "Init_Transform_FailedEntities",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Return_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "transformFailedEntities",
					"value": {
						"value": "@json('[]')",
						"type": "Expression"
					}
				}
			},
			{
				"name": "Init_Transform_FailedErrors",
				"type": "SetVariable",
				"dependsOn": [
					{
						"activity": "Return_RunSummary",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"variableName": "transformFailedErrors",
					"value": {
						"value": "@json('[]')",
						"type": "Expression"
					}
				}
			},
			{
				"name": "ForEach_Transform_Results",
				"type": "ForEach",
				"dependsOn": [
					{
						"activity": "Init_Transform_FailedEntities",
						"dependencyConditions": [
							"Succeeded"
						]
					},
					{
						"activity": "Init_Transform_FailedErrors",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"userProperties": [],
				"typeProperties": {
					"items": {
						"value": "@if(\n  equals(variables('transformResultJson'), 'null'),\n  json('[]'),\n  json(variables('transformResultJson')).results\n)\n",
						"type": "Expression"
					},
					"batchCount": 4,
					"activities": [
						{
							"name": "If_Transform_Item_Failed",
							"type": "IfCondition",
							"dependsOn": [],
							"userProperties": [],
							"typeProperties": {
								"expression": {
									"value": "@equals(item().status,'Failed')\n",
									"type": "Expression"
								},
								"ifTrueActivities": [
									{
										"name": "Append_FailedEntity",
										"type": "AppendVariable",
										"dependsOn": [],
										"userProperties": [],
										"typeProperties": {
											"variableName": "transformFailedEntities",
											"value": {
												"value": "@item().entity\n",
												"type": "Expression"
											}
										}
									},
									{
										"name": "Append_FailedErrors",
										"type": "AppendVariable",
										"dependsOn": [
											{
												"activity": "Append_FailedEntity",
												"dependencyConditions": [
													"Succeeded"
												]
											}
										],
										"userProperties": [],
										"typeProperties": {
											"variableName": "transformFailedErrors",
											"value": {
												"value": "@concat(item().entity, ': ', coalesce(item().error, 'Unknown error'))\n",
												"type": "Expression"
											}
										}
									}
								]
							}
						}
					]
				}
			}
		],
		"parameters": {
			"runInit": {
				"type": "bool",
				"defaultValue": true
			},
			"runIngestSB": {
				"type": "bool",
				"defaultValue": true
			},
			"runIngestHZ": {
				"type": "bool",
				"defaultValue": true
			},
			"sbEntitiesFilter": {
				"type": "array",
				"defaultValue": []
			},
			"hzEntitiesFilter": {
				"type": "array",
				"defaultValue": []
			},
			"previousRunSummaryPath": {
				"type": "string",
				"defaultValue": "''"
			},
			"runCuratedToMiPINS": {
				"type": "bool",
				"defaultValue": true
			},
			"mipinsEntitiesFilter": {
				"type": "array",
				"defaultValue": []
			},
			"runTransformAndLoad": {
				"type": "bool",
				"defaultValue": true
			},
			"transformStages": {
				"type": "array",
				"defaultValue": [
					"standardised",
					"harmonised",
					"curated"
				]
			},
			"transformRetryCount": {
				"type": "int",
				"defaultValue": 2
			}
		},
		"variables": {
			"runContextJson": {
				"type": "String"
			},
			"sbEntities": {
				"type": "Array"
			},
			"hzEntities": {
				"type": "Array"
			},
			"sbResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"hzResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"runSummaryJson": {
				"type": "String"
			},
			"manifestPath": {
				"type": "String"
			},
			"mipinsResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"failureMessage": {
				"type": "String"
			},
			"sbFailedEntities": {
				"type": "Array",
				"defaultValue": []
			},
			"hzFailedEntities": {
				"type": "Array",
				"defaultValue": []
			},
			"mipinsFailedEntities": {
				"type": "Array",
				"defaultValue": []
			},
			"sbFailedErrors": {
				"type": "Array",
				"defaultValue": []
			},
			"hzFailedErrors": {
				"type": "Array",
				"defaultValue": []
			},
			"mipinsFailedErrors": {
				"type": "Array",
				"defaultValue": []
			},
			"transformResultJson": {
				"type": "String",
				"defaultValue": "null"
			},
			"transformFailedEntities": {
				"type": "Array",
				"defaultValue": []
			},
			"transformFailedErrors": {
				"type": "Array",
				"defaultValue": []
			}
		},
		"folder": {
			"name": "utils/Master"
		},
		"annotations": []
	}
}