{
	"name": "harmonised_pins_inspector_troubleshooting",
	"properties": {
		"content": {
			"query": "-- Query 1A: Count records missing firstName/lastName\nSELECT \n    COUNT(*) as records_missing_names,\n    COUNT(CASE WHEN firstName IS NULL AND lastName IS NULL THEN 1 END) as both_null,\n    COUNT(CASE WHEN firstName IS NULL AND lastName IS NOT NULL THEN 1 END) as firstname_only_null,\n    COUNT(CASE WHEN firstName IS NOT NULL AND lastName IS NULL THEN 1 END) as lastname_only_null,\n    COUNT(CASE WHEN emailAddress IS NULL THEN 1 END) as email_null\nFROM [odw_harmonised_db].[dbo].[pins_inspector_test]\nWHERE IsActive = 'Y';\n\n-- -- Query 1B: Identify inspectors missing names\nSELECT TOP 20\n    sapId,\n    entraId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    grade,\n    unit,\n    postName\nFROM [odw_harmonised_db].[dbo].[pins_inspector_test]\nWHERE IsActive = 'Y'\n    AND (firstName IS NULL OR lastName IS NULL)\nORDER BY sapId\n\n-- -- Query 1C: Check if these inspectors exist in specialisms table\nWITH missing_names AS (\n    SELECT DISTINCT sapId, emailAddress\n    FROM [odw_harmonised_db].[dbo].[pins_inspector_test]\n    WHERE IsActive = 'Y'\n        AND (firstName IS NULL OR lastName IS NULL)\n)\nSELECT TOP 20\n    mn.sapId,\n    mn.emailAddress,\n    spec.pins_staff_number,\n    spec.given_names,\n    spec.family_name\nFROM missing_names mn\nLEFT JOIN odw_harmonised_db.dbo.live_dim_inspector spec \n    ON mn.sapId = spec.pins_staff_number\nORDER BY mn.sapId\n\n\n-- -- ============================================================================\n-- -- ISSUE 2: Missing Specialisms (177 records - likely same as Issue 1)\n-- -- ============================================================================\n\n-- Query 2A: Count records missing specialisms\nSELECT \n    COUNT(*) as total_active_inspectors,\n    COUNT(CASE WHEN specialism IS NULL THEN 1 END) as missing_specialisms,\n    COUNT(CASE WHEN specialism IS NOT NULL THEN 1 END) as has_specialisms\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n\n-- Query 2B: Breakdown by sourceSystem\nSELECT \n    sourceSystem,\n    COUNT(*) as total,\n    COUNT(CASE WHEN specialism IS NULL THEN 1 END) as missing_specialisms,\n    COUNT(CASE WHEN specialism IS NOT NULL THEN 1 END) as has_specialisms\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y' and entraId IS NULL\nGROUP BY sourceSystem;\n\n-- -- Query 2C: Check if PADS are the ones without specialisms\nSELECT TOP 30\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    sourceSystem,\n    grade,\n    unit\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND specialism IS NULL\nORDER BY sourceSystem, sapId\n\n-- -- Query 2D: Verify specialisms table has data for active inspectors\nSELECT \n    COUNT(DISTINCT StaffNumber) as unique_staff_in_specialisms,\n    COUNT(*) as total_specialism_records\nFROM odw_harmonised_db.dbo.sap_hr_inspector_specialisms\n--WHERE StaffNumber = '50422251'\n\nSELECT \n    COUNT(*) AS total_records,\n    SUM(CASE WHEN [Current] = 1 THEN 1 ELSE 0 END) AS active_records,\n    SUM(CASE WHEN [Current] = 1 AND (QualificationName IS NULL OR QualificationName = '') THEN 1 ELSE 0 END) AS missing_qualification_name,\n    SUM(CASE WHEN [Current] = 1 AND (Proficien IS NULL OR Proficien = '') THEN 1 ELSE 0 END) AS missing_proficiency,\n    SUM(CASE WHEN [Current] = 1 AND (ValidFrom IS NULL OR ValidFrom = '') THEN 1 ELSE 0 END) AS missing_valid_from,\n    SUM(CASE WHEN [Current] = 1 AND (\n        QualificationName IS NULL OR QualificationName = '' OR \n        Proficien IS NULL OR Proficien = '' OR \n        ValidFrom IS NULL OR ValidFrom = ''\n    ) THEN 1 ELSE 0 END) AS missing_any_field,\n    COUNT(DISTINCT CASE WHEN [Current] = 1 AND (\n        QualificationName IS NULL OR QualificationName = '' OR \n        Proficien IS NULL OR Proficien = '' OR \n        ValidFrom IS NULL OR ValidFrom = ''\n    ) THEN StaffNumber END) AS inspectors_with_incomplete_specialisms\nFROM odw_harmonised_db.dbo.sap_hr_inspector_specialisms;\n\n-- -- ============================================================================\n-- -- ISSUE 3: Empty Address Structures (appearing as {})\n-- -- ============================================================================\n\n-- -- Query 3A: Count address issues\nSELECT \n    COUNT(*) as total_active,\n    -- Count where address is empty JSON object {} or empty string\n    COUNT(CASE \n        WHEN address = '{}' \n          OR address = ''\n        THEN 1 \n    END) as address_empty,\n    -- Count where all key address fields are empty strings in JSON\n    COUNT(CASE \n        WHEN (JSON_VALUE(address, '$.addressLine1') = '' OR JSON_VALUE(address, '$.addressLine1') = '{}')\n         AND (JSON_VALUE(address, '$.townCity') = '' OR JSON_VALUE(address, '$.townCity') = '{}')\n         AND (JSON_VALUE(address, '$.postcode') = '' OR JSON_VALUE(address, '$.postcode') = '{}')\n         AND (JSON_VALUE(address, '$.county') = '' OR JSON_VALUE(address, '$.county') = '{}')\n        THEN 1 \n    END) as empty_address_fields,\n    -- Count where at least one address field has a non-empty value\n    COUNT(CASE \n        WHEN (JSON_VALUE(address, '$.addressLine1') IS NOT NULL AND JSON_VALUE(address, '$.addressLine1') != '' AND JSON_VALUE(address, '$.addressLine1') != '{}')\n          OR (JSON_VALUE(address, '$.townCity') IS NOT NULL AND JSON_VALUE(address, '$.townCity') != '' AND JSON_VALUE(address, '$.townCity') != '{}')\n          OR (JSON_VALUE(address, '$.postcode') IS NOT NULL AND JSON_VALUE(address, '$.postcode') != '' AND JSON_VALUE(address, '$.postcode') != '{}')\n          OR (JSON_VALUE(address, '$.county') IS NOT NULL AND JSON_VALUE(address, '$.county') != '' AND JSON_VALUE(address, '$.county') != '{}')\n        THEN 1 \n    END) as has_some_address_data,\n    -- Count where key fields are populated (not empty, not null)\n    COUNT(CASE WHEN JSON_VALUE(address, '$.addressLine1') = '' OR JSON_VALUE(address, '$.addressLine1') = '{}' THEN 1 END) as no_addressLine1,\n    COUNT(CASE WHEN JSON_VALUE(address, '$.townCity') = '' OR JSON_VALUE(address, '$.townCity') = '{}' THEN 1 END) as no_townCity,\n    COUNT(CASE WHEN JSON_VALUE(address, '$.postcode') = '' OR JSON_VALUE(address, '$.postcode') = '{}' THEN 1 END) as no_postcode,\n    COUNT(CASE WHEN JSON_VALUE(address, '$.county') = '' OR JSON_VALUE(address, '$.county') = '{}' THEN 1 END) as no_county\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n--total_active 595\n--address_null or empty 23\n--empty_address_fields 23\n--has_addressLine1 572\n--has_townCity 305\n--has_postcode 572\n--has_county 262\n\n-- Query 3B: Sample records with address data (CORRECTED for JSON)\nSELECT TOP 20\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    address,\n    JSON_VALUE(address, '$.addressLine1') as addressLine1,\n    JSON_VALUE(address, '$.townCity') as townCity,\n    JSON_VALUE(address, '$.postcode') as postcode,\n    JSON_VALUE(address, '$.county') as county\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n\n-- Query 3C: Identify records with all NULL address fields (CORRECTED for JSON)\nSELECT TOP 20\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    address,\n    JSON_VALUE(address, '$.addressLine1') as addressLine1,\n    JSON_VALUE(address, '$.addressLine2') as addressLine2,\n    JSON_VALUE(address, '$.townCity') as townCity,\n    JSON_VALUE(address, '$.county') as county,\n    JSON_VALUE(address, '$.postcode') as postcode\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND address IS NOT NULL\n    AND JSON_VALUE(address, '$.addressLine1') IS NULL\n    AND JSON_VALUE(address, '$.townCity') IS NULL\n    AND JSON_VALUE(address, '$.postcode') IS NULL;\n\n-- Query 3D: Check source address table (unchanged)\nSELECT \n    COUNT(DISTINCT StaffNumber) as unique_staff_with_address,\n    COUNT(*) as total_address_records\nFROM odw_harmonised_db.sap_hr_inspector_address;\n\n-- Query 3E: Find records with no address (CORRECTED for JSON and Synapse SQL)\nWITH no_address AS (\n    SELECT sapId\n    FROM odw_harmonised_db.dbo.pins_inspector_test\n    WHERE IsActive = 'Y'\n        AND (address IS NULL \n             OR address = '{}'\n             OR (JSON_VALUE(address, '$.addressLine1') IS NULL\n                 AND JSON_VALUE(address, '$.townCity') IS NULL\n                 AND JSON_VALUE(address, '$.postcode') IS NULL))\n)\nSELECT TOP 23\n    na.sapId,\n    addr.StaffNumber,\n    addr.StreetandHouseNumber,\n    addr.City,\n    addr.PostalCode\nFROM no_address na\nLEFT JOIN odw_harmonised_db.sap_hr_inspector_address addr \n    ON na.sapId = addr.StaffNumber\nORDER BY na.sapId;\n\n\n-- -- ============================================================================\n-- -- SUMMARY QUERY: Overall Data Quality Metrics\n-- -- ============================================================================\n\nSELECT \n    COUNT(*) as total_active_inspectors,\n    COUNT(CASE WHEN firstName IS NULL OR firstName = '' OR lastName IS NULL OR lastName = '' THEN 1 END) as missing_names,\n    COUNT(CASE WHEN specialism IS NULL OR specialism = '' OR specialism = '{}' THEN 1 END) as missing_specialisms,\n    COUNT(CASE WHEN address IS NULL OR address = '' OR address = '{}' THEN 1 END) as empty_address_structs,\n    COUNT(CASE WHEN postName IS NULL OR postName = '' THEN 1 END) as blank_postname,\n    COUNT(CASE WHEN title IS NULL OR title = '' THEN 1 END) as blank_title,\n    COUNT(CASE WHEN entraId IS NULL OR entraId = '' THEN 1 END) as missing_entraid,\n    COUNT(CASE WHEN emailAddress IS NULL OR emailAddress = '' THEN 1 END) as missing_email\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n\n-- ============================================================================\n-- Investigation: 177 Empty Specialisms\n-- ============================================================================\n\n-- Query 1: Identify which inspectors have empty specialisms\nSELECT \n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    grade,\n    unit,\n    sourceSystem,\n    postName\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND (specialism IS NULL OR specialism = '' OR specialism = '{}')\nORDER BY sourceSystem, sapId;\n\n\n-- Query 2: Check if these inspectors exist in the specialisms source table\nWITH missing_specs AS (\n    SELECT DISTINCT sapId, emailAddress, firstName, lastName\n    FROM odw_harmonised_db.dbo.pins_inspector_test\n    WHERE IsActive = 'Y'\n        AND (specialism IS NULL OR specialism = '' OR specialism = '{}')\n)\nSELECT \n    ms.sapId,\n    ms.emailAddress,\n    ms.firstName,\n    ms.lastName,\n    spec.StaffNumber,\n    spec.Firstname as spec_firstName,\n    spec.Lastname as spec_lastName,\n    spec.QualificationName,\n    spec.Proficien,\n    spec.ValidFrom,\n    spec.LastUpdated\nFROM missing_specs ms\nLEFT JOIN odw_harmonised_db.dbo.sap_hr_inspector_specialisms spec \n    ON ms.sapId = spec.StaffNumber\nORDER BY ms.sapId;\n\n\n-- Query 3: Count breakdown - how many are in specialisms table vs not\nWITH missing_specs AS (\n    SELECT DISTINCT sapId\n    FROM odw_harmonised_db.dbo.pins_inspector_test\n    WHERE IsActive = 'Y'\n        AND (specialism IS NULL OR specialism = '' OR specialism = '{}')\n)\nSELECT \n    COUNT(DISTINCT ms.sapId) as total_missing_specialisms,\n    COUNT(DISTINCT spec.StaffNumber) as found_in_specialisms_table,\n    COUNT(DISTINCT ms.sapId) - COUNT(DISTINCT spec.StaffNumber) as not_in_specialisms_table\nFROM missing_specs ms\nLEFT JOIN odw_harmonised_db.dbo.sap_hr_inspector_specialisms spec \n    ON ms.sapId = spec.StaffNumber;\n\n\n-- Query 4: Check if the 177 match the 177 missing names\nSELECT \n    COUNT(*) as total_with_empty_specialism,\n    COUNT(CASE WHEN firstName IS NULL OR firstName = '' OR lastName IS NULL OR lastName = '' THEN 1 END) as also_missing_names,\n    COUNT(CASE WHEN (firstName IS NOT NULL AND firstName != '') AND (lastName IS NOT NULL AND lastName != '') THEN 1 END) as has_names\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND (specialism IS NULL OR specialism = '' OR specialism = '{}');\n\n\n-- Query 5: Breakdown by sourceSystem - check if PADS accounts for many\nSELECT \n    sourceSystem,\n    COUNT(*) as count_missing_specialisms,\n    COUNT(CASE WHEN firstName IS NULL OR firstName = '' THEN 1 END) as also_missing_firstName,\n    COUNT(CASE WHEN lastName IS NULL OR lastName = '' THEN 1 END) as also_missing_lastName\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND (specialism IS NULL OR specialism = '' OR specialism = '{}')\nGROUP BY sourceSystem\nORDER BY count_missing_specialisms DESC;\n\n\n-- Query 6: Sample of those WITH specialisms for comparison\nSELECT TOP 10\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    sourceSystem\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND specialism IS NOT NULL \n    AND specialism != '' \n    AND specialism != '{}';\n\n\n-- Query 7: Check what percentage of total inspectors in specialisms table are active\nSELECT \n    COUNT(DISTINCT spec.StaffNumber) as total_staff_in_specialisms_table,\n    COUNT(DISTINCT insp.sapId) as active_inspectors,\n    COUNT(DISTINCT CASE WHEN insp.sapId IS NOT NULL THEN spec.StaffNumber END) as specialisms_matched_to_active,\n    COUNT(DISTINCT CASE WHEN insp.sapId IS NULL THEN spec.StaffNumber END) as specialisms_not_matched\nFROM odw_harmonised_db.dbo.sap_hr_inspector_specialisms spec\nLEFT JOIN odw_harmonised_db.dbo.pins_inspector_test insp \n    ON spec.StaffNumber = insp.sapId \n    AND insp.IsActive = 'Y';\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "odw_harmonised_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}