{
	"name": "harmonised_pins_inspector_troubleshooting",
	"properties": {
		"content": {
			"query": "\n\n-- Query 1A: Count records missing firstName/lastName\nSELECT \n    COUNT(*) as records_missing_names,\n    COUNT(CASE WHEN firstName IS NULL AND lastName IS NULL THEN 1 END) as both_null,\n    COUNT(CASE WHEN firstName IS NULL AND lastName IS NOT NULL THEN 1 END) as firstname_only_null,\n    COUNT(CASE WHEN firstName IS NOT NULL AND lastName IS NULL THEN 1 END) as lastname_only_null,\n    COUNT(CASE WHEN emailAddress IS NULL THEN 1 END) as email_null\nFROM [odw_harmonised_db].[dbo].[pins_inspector_test]\nWHERE IsActive = 'Y';\n\n-- -- Query 1B: Identify inspectors missing names\nSELECT TOP 20\n    sapId,\n    entraId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    grade,\n    unit,\n    postName\nFROM [odw_harmonised_db].[dbo].[pins_inspector_test]\nWHERE IsActive = 'Y'\n    AND (firstName IS NULL OR lastName IS NULL)\nORDER BY sapId\n\n-- -- Query 1C: Check if these inspectors exist in specialisms table\nWITH missing_names AS (\n    SELECT DISTINCT sapId, emailAddress\n    FROM [odw_harmonised_db].[dbo].[pins_inspector_test]\n    WHERE IsActive = 'Y'\n        AND (firstName IS NULL OR lastName IS NULL)\n)\nSELECT TOP 20\n    mn.sapId,\n    mn.emailAddress,\n    spec.pins_staff_number,\n    spec.given_names,\n    spec.family_name\nFROM missing_names mn\nLEFT JOIN odw_harmonised_db.dbo.live_dim_inspector spec \n    ON mn.sapId = spec.pins_staff_number\nORDER BY mn.sapId\n\n\n-- -- ============================================================================\n-- -- ISSUE 2: Missing Specialisms (177 records - likely same as Issue 1)\n-- -- ============================================================================\n\n-- Query 2A: Count records missing specialisms\nSELECT \n    COUNT(*) as total_active_inspectors,\n    COUNT(CASE WHEN specialism IS NULL THEN 1 END) as missing_specialisms,\n    COUNT(CASE WHEN specialism IS NOT NULL THEN 1 END) as has_specialisms\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n\n-- Query 2B: Breakdown by sourceSystem\nSELECT \n    sourceSystem,\n    COUNT(*) as total,\n    COUNT(CASE WHEN specialism IS NULL THEN 1 END) as missing_specialisms,\n    COUNT(CASE WHEN specialism IS NOT NULL THEN 1 END) as has_specialisms\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y' and entraId IS NULL\nGROUP BY sourceSystem;\n\n-- -- Query 2C: Check if PADS are the ones without specialisms\nSELECT TOP 30\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    specialism,\n    sourceSystem,\n    grade,\n    unit\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n    AND specialism IS NULL\nORDER BY sourceSystem, sapId\n\n-- -- Query 2D: Verify specialisms table has data for active inspectors\nSELECT \n    COUNT(DISTINCT StaffNumber) as unique_staff_in_specialisms,\n    COUNT(*) as total_specialism_records\nFROM odw_harmonised_db.dbo.sap_hr_inspector_specialisms;\n\n\n-- -- ============================================================================\n-- -- ISSUE 3: Empty Address Structures (appearing as {})\n-- -- ============================================================================\n\n-- -- Query 3A: Count address issues\nSELECT \n    COUNT(*) as total_active,\n    COUNT(CASE WHEN address = '' OR address IS NULL THEN 1 END) as address_null,\n    COUNT(CASE WHEN address != '' AND address IS NOT NULL THEN 1 END) as address_not_null\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y';\n\n-- -- Query 3B: Sample records with address data\nSELECT TOP 10\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    address\nFROM odw_harmonised_db.dbo.pins_inspector_test\nWHERE IsActive = 'Y'\n\n\n-- -- Query 3C: Identify records with all NULL address fields (likely showing as {})\nSELECT TOP 20\n    sapId,\n    emailAddress,\n    firstName,\n    lastName,\n    address,\n    address.addressLine1,\n    address.addressLine2,\n    address.townCity,\n    address.county,\n    address.postcode\nFROM odw_harmonised_db.pins_inspector\nWHERE IsActive = 'Y'\n    AND address IS NOT NULL\n    AND address.addressLine1 IS NULL\n    AND address.townCity IS NULL\n    AND address.postcode IS NULL\n\n\n-- -- Query 3D: Check source address table\n-- SELECT \n--     COUNT(DISTINCT StaffNumber) as unique_staff_with_address,\n--     COUNT(*) as total_address_records\n-- FROM odw_harmonised_db.sap_hr_inspector_address;\n\n-- -- Query 3E: Find the 23 records with no address\n-- WITH no_address AS (\n--     SELECT sapId\n--     FROM odw_harmonised_db.pins_inspector\n--     WHERE IsActive = 'Y'\n--         AND address IS NOT NULL\n--         AND address.addressLine1 IS NULL\n--         AND address.townCity IS NULL\n--         AND address.postcode IS NULL\n-- )\n-- SELECT \n--     na.sapId,\n--     addr.StaffNumber,\n--     addr.StreetandHouseNumber,\n--     addr.City,\n--     addr.PostalCode\n-- FROM no_address na\n-- LEFT JOIN odw_harmonised_db.sap_hr_inspector_address addr \n--     ON na.sapId = addr.StaffNumber\n-- LIMIT 23;\n\n\n-- -- ============================================================================\n-- -- ISSUE 4: Erroneous Record - SIMONE.COWDERY\n-- -- ============================================================================\n\n-- -- Query 4A: Find SIMONE.COWDERY record\n-- SELECT \n--     *\n-- FROM odw_harmonised_db.pins_inspector\n-- WHERE emailAddress LIKE '%SIMONE.COWDERY%'\n--     OR UPPER(firstName) LIKE '%SIMONE%' AND UPPER(lastName) LIKE '%COWDERY%';\n\n-- -- Query 4B: Check her details in live_dim_inspector\n-- SELECT \n--     *\n-- FROM odw_harmonised_db.live_dim_inspector\n-- WHERE pins_email_address LIKE '%SIMONE.COWDERY%'\n--     OR UPPER(pins_first_name) LIKE '%SIMONE%';\n\n-- -- Query 4C: Check her details in hist_sap_hr\n-- SELECT \n--     PersNo,\n--     FirstName,\n--     LastName,\n--     Position1,\n--     PayGrp,\n--     PersonnelArea,\n--     PersonnelSubArea,\n--     OrganizationalUnit,\n--     ingestionDate\n-- FROM odw_harmonised_db.hist_sap_hr\n-- WHERE UPPER(FirstName) LIKE '%SIMONE%' AND UPPER(LastName) LIKE '%COWDERY%'\n-- ORDER BY ingestionDate DESC\n-- LIMIT 5;\n\n-- -- Query 4D: Check if she should be classified as inspector\n-- SELECT \n--     di.pins_staff_number,\n--     di.pins_email_address,\n--     di.pins_first_name,\n--     di.pins_last_name,\n--     di.grade,\n--     di.active_status,\n--     hr.Position1,\n--     hr.PersonnelArea as unit,\n--     hr.PersonnelSubArea as service\n-- FROM odw_harmonised_db.live_dim_inspector di\n-- LEFT JOIN odw_harmonised_db.hist_sap_hr hr ON di.pins_staff_number = hr.PersNo\n-- WHERE di.pins_email_address LIKE '%SIMONE.COWDERY%'\n-- ORDER BY hr.ingestionDate DESC\n-- LIMIT 5;\n\n\n-- -- ============================================================================\n-- -- ISSUE 5: Blank postName/Title (4 records)\n-- -- Note: Code shows both come from same field (hr.Position1)\n-- -- ============================================================================\n\n-- -- Query 5A: Count blank postName/title\n-- SELECT \n--     COUNT(*) as total_active,\n--     COUNT(CASE WHEN postName IS NULL OR postName = '' THEN 1 END) as blank_postname,\n--     COUNT(CASE WHEN title IS NULL OR title = '' THEN 1 END) as blank_title,\n--     COUNT(CASE WHEN (postName IS NULL OR postName = '') AND (title IS NULL OR title = '') THEN 1 END) as both_blank\n-- FROM odw_harmonised_db.pins_inspector\n-- WHERE IsActive = 'Y';\n\n-- -- Query 5B: Identify records with blank postName/title\n-- SELECT \n--     sapId,\n--     entraId,\n--     emailAddress,\n--     firstName,\n--     lastName,\n--     postName,\n--     title,\n--     grade,\n--     unit,\n--     service\n-- FROM odw_harmonised_db.pins_inspector\n-- WHERE IsActive = 'Y'\n--     AND (postName IS NULL OR postName = '' OR title IS NULL OR title = '')\n-- ORDER BY sapId;\n\n-- -- Query 5C: Check hist_sap_hr for these records\n-- WITH blank_position AS (\n--     SELECT DISTINCT sapId\n--     FROM odw_harmonised_db.pins_inspector\n--     WHERE IsActive = 'Y'\n--         AND (postName IS NULL OR postName = '')\n-- )\n-- SELECT \n--     bp.sapId,\n--     hr.PersNo,\n--     hr.FirstName,\n--     hr.LastName,\n--     hr.Position1,\n--     hr.ingestionDate\n-- FROM blank_position bp\n-- LEFT JOIN odw_harmonised_db.hist_sap_hr hr ON bp.sapId = hr.PersNo\n-- ORDER BY bp.sapId, hr.ingestionDate DESC;\n\n\n-- -- ============================================================================\n-- -- SUMMARY QUERY: Overall Data Quality Metrics\n-- -- ============================================================================\n\n-- SELECT \n--     COUNT(*) as total_active_inspectors,\n--     COUNT(CASE WHEN firstName IS NULL OR lastName IS NULL THEN 1 END) as missing_names,\n--     COUNT(CASE WHEN specialisms IS NULL THEN 1 END) as missing_specialisms,\n--     COUNT(CASE WHEN address IS NOT NULL AND address.addressLine1 IS NULL AND address.townCity IS NULL THEN 1 END) as empty_address_structs,\n--     COUNT(CASE WHEN postName IS NULL OR postName = '' THEN 1 END) as blank_postname,\n--     COUNT(CASE WHEN title IS NULL OR title = '' THEN 1 END) as blank_title,\n--     COUNT(CASE WHEN entraId IS NULL THEN 1 END) as missing_entraid,\n--     COUNT(CASE WHEN emailAddress IS NULL THEN 1 END) as missing_email\n-- FROM odw_harmonised_db.pins_inspector\n-- WHERE IsActive = 'Y';\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "odw_harmonised_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}