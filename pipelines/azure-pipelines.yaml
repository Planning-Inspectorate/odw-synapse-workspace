name: Synapse CI/CD

# This is the main CI/CD pipeline of the ODW. This is used to manage the CI/CD through the dev, test and main branches
parameters:
# Whether or not to run tests
- name: runTests
  type: boolean
  default: true
# User-specified environment to deploy to
- name: env
  default: 'build'
  values:
  - 'build'
  - 'dev'
  - 'test'
  - 'prod'
- name: fullDeployment
  type: boolean
  default: false

# Run when Pull Request raised to the main branch
pr:
- main

# Run when merged into main
trigger:
 branches:
  include:
  - main

schedules:
- cron: '0 9 * * 1-5' # cron syntax defining a schedule. At 9am every week day
  displayName: Daily main branch run against the build env
  branches:
    include:
    - main
  always: true
  batch: false
- cron: '0 10 * * 1-5' # cron syntax defining a schedule. At 10am every week day
  displayName: Daily main branch deployment to the test env
  branches:
    include:
    - main
  always: true
  batch: false

# Import the common repository
resources:
  repositories:
  - repository: odw-common
    type: github
    name: Planning-Inspectorate/odw-common
    endpoint: Planning-Inspectorate
    ref: main

variables:
# Override the env the pipeline runs against depending on if the pipeline was triggered by a schedule
- name: env
  ${{ if eq( variables['Build.Reason'], 'Schedule' ) }}:
    ${{ if contains( variables['Build.CronSchedule.DisplayName'], 'test') }}:
      value: 'test'
    ${{ elseif contains( variables['Build.CronSchedule.DisplayName'], 'test') }}:
      value: 'build'
    ${{ else }}:
      value: ${{ parameters.env }
  ${{ else }}:
    value: ${{ parameters.env }
- name: adoEnvName
  ${{ if eq(variables.env, 'prod') }}:
    value: "Prod"
  ${{ elseif eq(variables.env, 'test') }}:
    value: "Test"
  ${{ elseif eq(variables.env, 'build') }}:
    value: "Build"
  ${{ else }}:
    value: "Dev"
- name: variableGroupName
  value: "Terraform ${{ variables.adoEnvName }}"
- name: agentPool
  value: 'pins-agent-pool-odw-${{ variables.env }}-uks'
- name: azureSubscription
  value: 'pins-agent-pool-odw-${{ variables.env }}-uks'
- group: ${{ variables.variableGroupName }}

stages:
- ${{ if eq(variables.env, 'build') }}:
  - template: stages/run-ado-script-tests.yaml
    parameters:
      agentPool: ${{ variables.agentPool }}

- template: pipelines/stages/wait-for-approval.yaml@odw-common

- ${{ if eq(parameters.runTests, true) }}:
  - template: stages/run-odw-package-tests.yaml
    parameters:
      agentPool: ${{ variables.agentPool }}
      env: ${{ variables.env }}

- template: stages/deploy-synapse-stage.yaml
  parameters:
    agentPool: ${{ variables.agentPool }}
    env: ${{ variables.env }}
    armServiceConnectionName: "ODW ${{ upper(variables.env) }} - Infrastructure"
    fullDeployment: ${{ parameters.fullDeployment }}
    adoEnvName: ${{ variables.adoEnvName }}

- ${{ if eq(parameters.runTests, true) }}:
  - template: stages/conditional-run-tests.yaml
    parameters:
      agentPool: ${{ variables.agentPool }}
      env: ${{ variables.env }}
