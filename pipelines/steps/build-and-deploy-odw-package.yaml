parameters:
  - name: armServiceConnectionName
    type: string
  - name: env
    type: string

steps:
  - script: |
      set -e
      # Fetch all previous commits. See https://git-scm.com/docs/shallow
      git fetch --depth=2147483647
      # Build id set to the most recent commit hash for the odw folder- this is used to work out if the package has already been uploaded to Synapse
      buildId=$(git rev-list -1 HEAD $(Build.SourcesDirectory)/odw/)
      echo "Building with timestamp $buildId"
      poetry build --config-settings local-version=$buildId

      # Determine the produced wheel (pick the most recent in dist/)
      wheel_path=$(ls -1t dist/odw-*.whl | head -n 1)
      if [ -z "$wheel_path" ]; then
        echo "ERROR: No ODW wheel found in dist/ after build"
        ls -al dist || true
        exit 1
      fi
      wheel_name=$(basename "$wheel_path")

      export PYTHONPATH="${PYTHONPATH}:/./"
      python3 $(Build.SourcesDirectory)/pipelines/scripts/deploy_odw_package.py -e ${{ parameters.env }} -wn "$wheel_name"
    displayName: 'Build and Deploy ODW package'
    name: BuildODWPackage
